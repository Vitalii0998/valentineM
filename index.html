<!doctype html>
<html lang="uk">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Heart Physics</title>

<style>
html,body{
  margin:0;
  height:100%;
  background:radial-gradient(circle at 50% 40%, #1b2040 0%, #0d1025 70%);
  display:flex;
  align-items:center;
  justify-content:center;
  overflow:hidden;
}
#stage{
  width:98vmin;
  height:98vmin;
}
canvas{width:100%;height:100%}
</style>
</head>
<body>
<div id="stage"></div>

<script src="https://cdn.jsdelivr.net/npm/matter-js@0.19.0/build/matter.min.js"></script>
<script>
const {Engine,Render,Runner,Bodies,Composite,Body,Events} = Matter;

const stage=document.getElementById("stage");
const engine=Engine.create();
engine.positionIterations=10;
engine.velocityIterations=10;

const w=stage.clientWidth;
const h=stage.clientHeight;

const render=Render.create({
  element:stage,
  engine,
  options:{
    width:w,
    height:h,
    wireframes:false,
    background:"transparent"
  }
});

Render.run(render);
Runner.run(Runner.create(),engine);

// ---------------- HEART SHAPE ----------------

function heartPoints(cx,cy,scale,n=220){
  const pts=[];
  for(let i=0;i<n;i++){
    const t=(i/n)*Math.PI*2;
    const x=16*Math.pow(Math.sin(t),3);
    const y=13*Math.cos(t)-5*Math.cos(2*t)-2*Math.cos(3*t)-Math.cos(4*t);
    pts.push({x:cx+x*scale,y:cy-y*scale});
  }
  return pts;
}

const centerX=w/2;
const centerY=h/2;
const scale=Math.min(w,h)*0.03;

function pointInsideHeart(x,y){
  const dx=(x-centerX)/scale;
  const dy=(centerY-y)/scale;
  return Math.pow(dx*dx+dy*dy-1,3)-dx*dx*dy*dy*dy <= 0;
}

const pts=heartPoints(centerX,centerY,scale);

// —Ñ—ñ–∑–∏—á–Ω—ñ —Å—Ç—ñ–Ω–∫–∏
for(let i=0;i<pts.length;i++){
  const a=pts[i];
  const b=pts[(i+1)%pts.length];
  const dx=b.x-a.x;
  const dy=b.y-a.y;
  const len=Math.hypot(dx,dy);
  const angle=Math.atan2(dy,dx);

const wall=Bodies.rectangle(
  (a.x+b.x)/2,
  (a.y+b.y)/2,
  len+25,
  25,
  {
    isStatic:true,
    collisionFilter:{
      category:0x0001
    }
  }
);
  Body.setAngle(wall,angle);
  Composite.add(engine.world,wall);
}

// ---------------- PARTICLES ----------------

const hearts=[];
let textMode=false;
let textPoints=[];
let targets=[];

function randomInside(){
  let x,y;
  do{
    x=centerX+(Math.random()-0.5)*scale*18;
    y=centerY+(Math.random()-0.5)*scale*18;
  }while(!pointInsideHeart(x,y));
  return {x,y};
}

function spawn(){
  const r = 6 + Math.random()*3;
  const pos = randomInside();

const body = Bodies.circle(pos.x,pos.y,r,{
  restitution:0.05,
  friction:0.15,
  frictionAir:0.001,
  density:0.003,
  render:{visible:false}
});

  Composite.add(engine.world,body);
  hearts.push({body,r});

  // üî• –∞–∫—Ç–∏–≤–∞—Ü—ñ—è —Ç–µ–∫—Å—Ç—É
  if(hearts.length>200 && !textMode){
    textMode=true;
    generateTextPoints();
  }

  // üî• –ª—ñ–º—ñ—Ç —á–∞—Å—Ç–∏–Ω–æ–∫ (–∑–∞–≤–∂–¥–∏ –ø–æ–∑–∞ textMode)
  if(hearts.length>700){
    Composite.remove(engine.world,hearts.shift().body);
  }
}

// ---------------- TEXT ----------------

function generateTextPoints(){

  const off=document.createElement("canvas");
  off.width=w;
  off.height=h;
  const ctx=off.getContext("2d");

  ctx.fillStyle="white";
  ctx.textAlign="center";
  ctx.textBaseline="middle";

  // V –ª—ñ–≤–æ—Ä—É—á
  ctx.font="bold 90px Arial";
  ctx.fillText("V", w/2 - 120, h/2 - 40);

  // M –ø—Ä–∞–≤–æ—Ä—É—á
  ctx.fillText("M", w/2 + 120, h/2 - 40);

  // Valentine –∑–Ω–∏–∑—É
  ctx.font="bold 60px Arial";
  ctx.fillText("Valentine", w/2, h/2 + 120);

  const data=ctx.getImageData(0,0,w,h).data;

  textPoints=[];
  for(let y=0;y<h;y+=6){
    for(let x=0;x<w;x+=6){
      const i=(y*w+x)*4;
      if(data[i+3]>150 && pointInsideHeart(x,y)){
        textPoints.push({x,y});
      }
    }
  }

  targets=[];
  for(let i=0;i<hearts.length;i++){
    targets[i]=textPoints[i%textPoints.length];
  }
}


// ---------------- RENDER ----------------

Events.on(render,"afterRender",()=>{
  const ctx=render.context;

  // –∫–æ–Ω—Ç—É—Ä —Å–µ—Ä—Ü—è
  ctx.beginPath();
  ctx.moveTo(pts[0].x,pts[0].y);
  for(let p of pts) ctx.lineTo(p.x,p.y);
  ctx.closePath();

  const grad=ctx.createLinearGradient(0,0,w,h);
  grad.addColorStop(0,"#ff6aa2");
  grad.addColorStop(1,"#ff003c");

  ctx.strokeStyle=grad;
  ctx.lineWidth=6;
  ctx.shadowBlur=25;
  ctx.shadowColor="#ff3d7a";
  ctx.stroke();
  ctx.shadowBlur=0;

  // —á–∞—Å—Ç–∏–Ω–∫–∏
  ctx.textAlign="center";
  ctx.textBaseline="middle";
  for(const hrt of hearts){
    const p=hrt.body.position;
    ctx.save();
    ctx.translate(p.x,p.y);
    ctx.rotate(hrt.body.angle);
    ctx.font=hrt.r*2+"px system-ui, Apple Color Emoji";
    ctx.fillText("‚ù§Ô∏è",0,0);
    ctx.restore();
  }
});

// ---------------- MOTION ----------------

let lastShake=0;

function motion(e){

  const now=Date.now();

  // TEXT MODE
if(textMode){

  engine.gravity.x = 0;
  engine.gravity.y = 0;

  // üî• –≤–∏–º–∏–∫–∞—î–º–æ –∫–æ–ª—ñ–∑—ñ—ó —Ç—ñ–ª—å–∫–∏ –ø—ñ—Å–ª—è –∑–∞–ø–æ–≤–Ω–µ–Ω–Ω—è
  for(const h of hearts){
    h.body.collisionFilter.mask = 0;
  }

  for(let i=0;i<hearts.length;i++){
    const h = hearts[i];
    const t = targets[i];
    if(!t) continue;

    const dx = t.x - h.body.position.x;
    const dy = t.y - h.body.position.y;

    Body.setVelocity(h.body,{
      x: dx * 0.2,
      y: dy * 0.2
    });
  }

  return;
}

  // NORMAL MODE

  const a=e.acceleration||e.accelerationIncludingGravity;
  if(a){
    const mag=Math.sqrt((a.x||0)**2+(a.y||0)**2+(a.z||0)**2);

    if(mag>14 && now-lastShake>200){
      lastShake=now;
      for(let i=0;i<20;i++) spawn();
    }
  }

  const g=e.accelerationIncludingGravity;
  if(g){
    engine.gravity.x=-(g.x||0)/10;
    engine.gravity.y=(g.y||0)/10;
  }
}

window.addEventListener("pointerdown",()=>{
  window.addEventListener("devicemotion",motion,{passive:true});
},{once:true});

window.addEventListener("keydown",e=>{
  if(e.code==="Space"){
    for(let i=0;i<20;i++) spawn();
  }
});
</script>
</body>
</html>






